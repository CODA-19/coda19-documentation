# CODA-19 authorization flow

<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="1242px" viewBox="-0.5 -0.5 1242 761" content="&lt;mxfile host=&quot;app.diagrams.net&quot; modified=&quot;2020-11-19T19:26:44.316Z&quot; agent=&quot;5.0 (Macintosh; Intel Mac OS X 10_15_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.198 Safari/537.36&quot; etag=&quot;h0f3r4SlNbOUEIDztMYm&quot; version=&quot;13.9.9&quot; type=&quot;github&quot;&gt;&lt;diagram id=&quot;xXC8S_svYIRL2FnE1IQ2&quot; name=&quot;Page-1&quot;&gt;7V1bc5s4FP41fowHAeLy6CRtt912t7PptNu+dGSQbTYYuYATp79+JUAYkIwhxgY7cWYScwBhH33nOxcdyEi7WW7ehWi1+ERc7I9Uxd2MtNuRqhpQo7+Z4CkVAMU0U8k89NxMthXceb8xPzCTrj0XR6UDY0L82FuVhQ4JAuzEJRkKQ/JYPmxG/PJVV2iOBcGdg3xR+s1z40Uq1RVF2e74A3vzRXZptivds0T86EwQLZBLHgsi7c1IuwkJidN3y80N9pn2uGLS897u2Jt/shAHcZMTPnz9gn6ghx8APDrXP77HD78D7yqbjSh+4t8Yu1QB2SYJ4wWZkwD5b7bS65CsAxezURW6tT3mIyErKgRU+B+O46dsNtE6JlS0iJd+thdvvPhfdvrYhNnm98Ku2002dLLxxDeCOHxKz1Ih3/5e3Lk9L9niJ0ZxSO7z2aNqvxY1lykzIuvQwTXq4hBE4RzHNcdlsGe6LFwgm5d3mCwx/YT0gBD7KPYeymBDGWbn+XHZqZMwRE+FA1bEC+KoMPJnJqAHZOan2hn0Musz9ApCKsdr9cfTN+kn4FuFr7IVJahrgUBu6X1BsIhA5XkIBANEoN01AgsoeMYkp+M+IH+dXekOhw84ZAyPGYQNn36Z6ykVGHP27sO3L4yuQ7Kkf/7ET45P0L0AlDIMHhdejO9WKNHfI/VH5Smfeb5/Q3wSJudqM8h+8tkp7DGSFzuDBHFBnr7qZo9+oxhvavXNTVMpmxrkXuJx62UAly0KDsZQjjRFxqsZtjBDtaEZgkE4AmC1cwSq1oMjUAWOuPE9nHwsCpwFfec5KMbRBbFAbuGZns3eWcAaUDxYTwNdWrPW0Jr1QVizDttZM1R6sGZttzUv0T2zYqqlX2scMck68oI5/Zt4/Yuxbs0YmnUD2Kd5g6Jt5w5/n5MvpXrj3OHv9PEojCcs8aeCgASYy956TFWdM4feNA5QBxWP67vjcSrz3NTPSoPyizFPXR9aCA6FWRHNNXAr6C6od6dS9qKu8JWh5BtzWTu/JjouuR/KR0itLTupxqEBdUc8m4+U2qMwUmc1CyBOzEDLZiLZlSjS8VEUeU6FJWvBtJcT7b6iqYOMzxaMr0HZAbTnPMvBjiPjvKkFWWR3lPKCLuG2PDw5Teih92syz6gv5PWEpqHHyS2NRxXnVg3sNctsE4aeOpxsPKHAHNaMisUbHlBWg0gq9GZekgAix8GRJM5c4XDpUWMhwSUVe4zhlXwl8eUl2SGbzOxjqAfapdnQLuHAmNbcaZfKHAc4TBO9QimGzhZF33pKf08+v78g8zONoZkfv9hLyfc0tat8TxjpyPme2XO+96zFMbPl4li/DJt39+xjWAMOimFzIioUuv++nVwBm31rSo9HIFIXYsvVZURqqVMtIdIOCNOuLE6p/ROmmKMLehVU4iYvpizefwUEKIOSubItNI2Iv47xJHQyfCfSfKsW7C3y9CpFQlHHeRdPUcfVgldnOtYaOCUXRYsculnnHZome5Va4EJg6W81AbicbhZoxcZYbuasmXA8d1bqeIE37+klWFYQpm9u7/HTzyUK0BwvqeZ/RjSg8ZjhXNOpiLML+2iK/c+EGqCXnBOmqmPZB1tG9j9W9i89101YG/nenAkcOjQNk7ZnTLId+ZERNVcvmH/EM3ZRKEYvdvIqsySQA6ce7vvhlMGHeYoqfHRdRI9md+LfYQm7lPL45fkQZDaL8FE8staUdhWKFgHAVJ1xGahSQBbRm4maw0NG6WXS7x4GPNQtkwrQxlrppYo8LosCd53XPeeICx93MQmpouiJwajYAKYQlrqQeJGtVa39+Gxmt7V3gJWURdNF87Zqwvfulw3FVX0xML6gjAVAewxMZfuqWMCzExjA6wSnSmB6rb6fU6VHb7qib3be432YaYpL+luHOPHca7IRIHBQMWeGDfk6lmvaU6UjBqzmIBICPG0Koouu6u8QBXMWb3z9dARX5Cfh5SGOqLFttGidqMyKJDGUkbR2tFkx9vul804MZcn3aRNDXSwlCzp+TQxPkhjmcH9NDEXdWDV+8LISwxYwONPEUBcLfu9CjIOX7GyBafXsbaFYIvyEojjJyF/stMhy8xNPi6Qklt9As1q90HkxjL6DU6juD5wuqWjS2SrviRd5DU2cltcaiRTRTe+XGlg3DJTclJTHhh31vAhppm2YGjLElAcDF2KzG86r9rbI2n1PfCvDgG4n3tcg37MxNS04wmEVHKGsHpB2cjLllObe+LUmfMdVlKhtQg8AYLWhfxL1Kb4X4CuOTbaXVTfg9lzeHCq2i3IJ/RrplblYAsAkvS+DpnnmFmL62Qv1jOxGTTo4vB7B20awqLUWweLzB9tkVx0VHx0jYwJlrAKglcgAHObkj5+yQzFl51MarVDQCEkaQ1IVKjhievOiBRsCO+uQJf/OAlGN+rUwSi/7gmF0pYwBMEAJR1cHAonD0RprWvmkI0KrblXkrLuzqi6//+4sDpchuPx9jw7o1+VbsKHLb5zoncblG6I1tXb5UqL+hqd3xLlnHKDkxMx3RjQ5LnDz9JIDAWMXDzyLwXXTKHEEPIzA5cX9k9K5WA/uPIHblabtTuw6YHNhnbt3NjclRarBPgmmXzo3mtI5X3EbCp03eN7Aea2am/yOtnyBS1wrOe2qudGgM+F11RyPTrBqnsP9ddVc1I1YzOE9Y8o/byZ0W1lHyQKfE2KXPYoN+eK9uWe1et4CDpxdyvlwsgouemlZQ27h0O4ddc+P8D2fSqvV9MEkPGweiJ8265YtzrqIAZTqkl/vca/V6yrgaczpLVp6PhvmhpqMl9D6X/ix4ln1g2yNm9BeW7PUYdmaGK9dRoYpmFr/KSafelnDSogdTCdb8nAQF8WoU/33/AjY6rz0/5RIS5YXtivzqaqszCeU9kBdXW9vFc/3vVW0KyYs1vWiVfqvIWbehmFEvJVhpia3MrTiRiFkFVNlY2rArgpERjk70AwxNdEkIDlaV5M1oAX+YZeHYNOw0+r8yQbyPNPe5QnadmxVB8obuE7UsWWJ5eAjEZX6SlRN/RlQB8ZUds+V7PNJkM2mfX3c8I7NVABUe0urDNO4ubQ6kkB6R+YqW3brdBdNLrVrp1kYvYe9zrTdhRt2F11TwOZt2rz8mpXVDkSwWR7UHtull1Ue7zkFXrq5/R9i6eHbf8Wmvfkf&lt;/diagram&gt;&lt;/mxfile&gt;" onclick="(function(svg){var src=window.event.target||window.event.srcElement;while (src!=null&amp;&amp;src.nodeName.toLowerCase()!='a'){src=src.parentNode;}if(src==null){if(svg.wnd!=null&amp;&amp;!svg.wnd.closed){svg.wnd.focus();}else{var r=function(evt){if(evt.data=='ready'&amp;&amp;evt.source==svg.wnd){svg.wnd.postMessage(decodeURIComponent(svg.getAttribute('content')),'*');window.removeEventListener('message',r);}};window.addEventListener('message',r);svg.wnd=window.open('https://viewer.diagrams.net/?client=1&amp;page=0&amp;edit=_blank');}}})(this);" style="cursor:pointer;max-width:100%;max-height:761px;"><defs/><g><path d="M 250 560 L 250 620 L 350 620 L 350 691.76" fill="none" stroke="#000000" stroke-width="2" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 350 697.76 L 346 689.76 L 350 691.76 L 354 689.76 Z" fill="#000000" stroke="#000000" stroke-width="2" stroke-miterlimit="10" pointer-events="all"/><path d="M 220 500 L 220 480 L 250 480 L 250 468.24" fill="none" stroke="#000000" stroke-width="2" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 250 462.24 L 254 470.24 L 250 468.24 L 246 470.24 Z" fill="#000000" stroke="#000000" stroke-width="2" stroke-miterlimit="10" pointer-events="all"/><rect x="160" y="500" width="120" height="60" fill="#f5f5f5" stroke="#666666" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 530px; margin-left: 161px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #333333; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">Server gets<br />JWT from Keycloak</div></div></div></foreignObject><text x="220" y="534" fill="#333333" font-family="Helvetica" font-size="12px" text-anchor="middle">Server gets...</text></switch></g><path d="M 140 700 L 140 620 L 190 620 L 190 568.24" fill="none" stroke="#000000" stroke-width="2" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 190 562.24 L 194 570.24 L 190 568.24 L 186 570.24 Z" fill="#000000" stroke="#000000" stroke-width="2" stroke-miterlimit="10" pointer-events="all"/><rect x="80" y="700" width="120" height="60" fill="#f5f5f5" stroke="#666666" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 730px; margin-left: 81px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #333333; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">Client authenticates</div></div></div></foreignObject><text x="140" y="734" fill="#333333" font-family="Helvetica" font-size="12px" text-anchor="middle">Client authenticates</text></switch></g><path d="M 410 700 L 410 620 L 460 620 L 460 568.24" fill="none" stroke="#000000" stroke-width="2" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 460 562.24 L 464 570.24 L 460 568.24 L 456 570.24 Z" fill="#000000" stroke="#000000" stroke-width="2" stroke-miterlimit="10" pointer-events="all"/><rect x="320" y="700" width="120" height="60" fill="#f5f5f5" stroke="#666666" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 730px; margin-left: 321px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #333333; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">Client makes request using JWT</div></div></div></foreignObject><text x="380" y="734" fill="#333333" font-family="Helvetica" font-size="12px" text-anchor="middle">Client makes request...</text></switch></g><path d="M 520 530 L 551.76 530" fill="none" stroke="#000000" stroke-width="2" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 557.76 530 L 549.76 534 L 551.76 530 L 549.76 526 Z" fill="#000000" stroke="#000000" stroke-width="2" stroke-miterlimit="10" pointer-events="all"/><rect x="400" y="500" width="120" height="60" fill="#f5f5f5" stroke="#666666" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 530px; margin-left: 401px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #333333; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">Server validates<br />JWT</div></div></div></foreignObject><text x="460" y="534" fill="#333333" font-family="Helvetica" font-size="12px" text-anchor="middle">Server validates...</text></switch></g><path d="M 0 620 L 1240 620" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 430 468.24 L 430 480 L 460 480 L 460 491.76" fill="none" stroke="#000000" stroke-width="2" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 430 462.24 L 434 470.24 L 430 468.24 L 426 470.24 Z" fill="#000000" stroke="#000000" stroke-width="2" stroke-miterlimit="10" pointer-events="all"/><path d="M 460 497.76 L 456 489.76 L 460 491.76 L 464 489.76 Z" fill="#000000" stroke="#000000" stroke-width="2" stroke-miterlimit="10" pointer-events="all"/><rect x="160" y="400" width="360" height="60" rx="9" ry="9" fill="#f8cecc" stroke="#b85450" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 358px; height: 1px; padding-top: 430px; margin-left: 161px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">Keycloak</div></div></div></foreignObject><text x="340" y="434" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">Keycloak</text></switch></g><path d="M 620 491.76 L 620 430 L 528.24 430" fill="none" stroke="#000000" stroke-width="2" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 620 497.76 L 616 489.76 L 620 491.76 L 624 489.76 Z" fill="#000000" stroke="#000000" stroke-width="2" stroke-miterlimit="10" pointer-events="all"/><path d="M 522.24 430 L 530.24 426 L 528.24 430 L 530.24 434 Z" fill="#000000" stroke="#000000" stroke-width="2" stroke-miterlimit="10" pointer-events="all"/><path d="M 680 530 L 711.76 530" fill="none" stroke="#000000" stroke-width="2" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 717.76 530 L 709.76 534 L 711.76 530 L 709.76 526 Z" fill="#000000" stroke="#000000" stroke-width="2" stroke-miterlimit="10" pointer-events="all"/><rect x="560" y="500" width="120" height="60" fill="#f5f5f5" stroke="#666666" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 530px; margin-left: 561px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #333333; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">Server<br />verifies access<br />permissions</div></div></div></foreignObject><text x="620" y="534" fill="#333333" font-family="Helvetica" font-size="12px" text-anchor="middle">Server...</text></switch></g><path d="M 840 530 L 940 530 L 940 468.24" fill="none" stroke="#000000" stroke-width="2" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 940 462.24 L 944 470.24 L 940 468.24 L 936 470.24 Z" fill="#000000" stroke="#000000" stroke-width="2" stroke-miterlimit="10" pointer-events="all"/><rect x="720" y="500" width="120" height="60" fill="#f5f5f5" stroke="#666666" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 530px; margin-left: 721px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #333333; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">Server generates request to hub API</div></div></div></foreignObject><text x="780" y="534" fill="#333333" font-family="Helvetica" font-size="12px" text-anchor="middle">Server generates req...</text></switch></g><path d="M 0 300 L 1240 300" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 940 200 L 940 179 L 939.5 179 L 939.5 166.24" fill="none" stroke="#000000" stroke-width="2" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 939.5 160.24 L 943.5 168.24 L 939.5 166.24 L 935.5 168.24 Z" fill="#000000" stroke="#000000" stroke-width="2" stroke-miterlimit="10" pointer-events="all"/><rect x="880" y="200" width="120" height="60" fill="#d5e8d4" stroke="#82b366" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 230px; margin-left: 881px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">CODA-19 site API</div></div></div></foreignObject><text x="940" y="234" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">CODA-19 site API</text></switch></g><rect x="200" y="330" width="290" height="40" rx="1" ry="1" fill="#000000" stroke="#000000" transform="translate(2,3)" opacity="0.25"/><rect x="200" y="330" width="290" height="40" rx="1" ry="1" fill="#ffffff" stroke="#dddddd" pointer-events="all"/><path d="M 221.19 363.26 C 220.2 363.26 219.26 362.72 218.77 361.7 L 213 351.3 C 212.48 350.39 212.56 349.33 213 348.58 L 218.82 338.17 C 219.31 337.23 220.2 336.74 221.09 336.74 L 232.78 336.74 C 233.65 336.74 234.51 337.18 235.02 338.07 L 240.82 348.46 C 241.52 349.56 241.28 350.73 240.88 351.38 L 235.12 361.72 C 234.73 362.55 233.86 363.26 232.74 363.26 Z" fill="#5184f3" stroke="none" pointer-events="all"/><path d="M 229.65 363.26 L 222.91 356.28 L 221.12 351.54 L 221.01 345.84 L 226.93 343.16 L 233.48 345.38 L 240.33 352.36 L 235.12 361.72 C 234.73 362.55 233.86 363.26 232.74 363.26 Z" fill-opacity="0.07" fill="#000000" stroke="none" pointer-events="all"/><rect x="212.48" y="336.74" width="0" height="0" fill="none" stroke="none" pointer-events="all"/><path d="M 226.95 349.24 C 227.32 349.24 227.85 348.86 227.85 348.27 C 227.85 347.78 227.41 347.35 226.97 347.35 C 226.51 347.35 226.05 347.74 226.05 348.3 C 226.05 348.83 226.58 349.24 226.95 349.24 Z M 227.53 354.87 L 226.38 354.87 L 226.38 354.07 L 225.51 354.07 L 225.51 352.96 L 226.38 352.96 L 226.38 352.57 L 224.81 352.57 L 224.81 351.46 L 226.38 351.46 L 226.38 350.27 C 225.57 350.11 224.91 349.32 224.91 348.34 C 224.91 347.04 225.92 346.23 226.97 346.23 C 227.93 346.23 228.97 347.01 228.97 348.32 C 228.97 349.23 228.44 350.03 227.53 350.24 Z M 226.97 357.51 C 228.69 356.91 230.06 355.77 230.63 354.96 C 231.86 353.31 232.41 351.42 232.41 349.8 L 232.41 346.13 L 226.94 343.63 L 221.48 346.16 L 221.48 349.78 C 221.48 351.71 222.38 354.05 223.64 355.39 C 224.64 356.44 225.59 357.05 226.97 357.51 Z M 226.99 358.71 C 225.18 358.24 223.61 357.32 222.29 355.52 C 221.1 353.92 220.43 352.09 220.43 350.12 L 220.43 345.38 L 226.98 342.33 L 233.48 345.38 L 233.48 350.42 C 233.48 352.45 232.36 354.66 231.26 355.94 C 230.22 357.18 229.02 358.17 226.99 358.71 Z" fill="#ffffff" stroke="none" pointer-events="all"/><rect x="270" y="343.33" width="150" height="13.33" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 148px; height: 1px; padding-top: 350px; margin-left: 271px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">CODA-19 site API key</div></div></div></foreignObject><text x="345" y="354" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">CODA-19 site API key</text></switch></g><rect x="520" y="325" width="80" height="50" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 78px; height: 1px; padding-top: 350px; margin-left: 521px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">Stored in Keycloak or other vault</div></div></div></foreignObject><text x="560" y="354" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">Stored in Key...</text></switch></g><path d="M 0 139.17 L 1240 139" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 1000 55 L 1100 55 L 1100 191.76" fill="none" stroke="#000000" stroke-width="2" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 1100 197.76 L 1096 189.76 L 1100 191.76 L 1104 189.76 Z" fill="#000000" stroke="#000000" stroke-width="2" stroke-miterlimit="10" pointer-events="all"/><rect x="880" y="25" width="120" height="60" fill="#ffe6cc" stroke="#d79b00" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 55px; margin-left: 881px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">CODA-19 AidBox</div></div></div></foreignObject><text x="940" y="59" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">CODA-19 AidBox</text></switch></g><rect x="0" y="20" width="150" height="30" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe flex-start; width: 148px; height: 1px; padding-top: 35px; margin-left: 2px;"><div style="box-sizing: border-box; font-size: 0; text-align: left; "><div style="display: inline-block; font-size: 22px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">Orange VM</div></div></div></foreignObject><text x="2" y="42" fill="#000000" font-family="Helvetica" font-size="22px">Orange VM</text></switch></g><rect x="200" y="200" width="290" height="40" rx="1" ry="1" fill="#000000" stroke="#000000" transform="translate(2,3)" opacity="0.25"/><rect x="200" y="200" width="290" height="40" rx="1" ry="1" fill="#ffffff" stroke="#dddddd" pointer-events="all"/><path d="M 221.19 233.26 C 220.2 233.26 219.26 232.72 218.77 231.7 L 213 221.3 C 212.48 220.39 212.56 219.33 213 218.58 L 218.82 208.17 C 219.31 207.23 220.2 206.74 221.09 206.74 L 232.78 206.74 C 233.65 206.74 234.51 207.18 235.02 208.07 L 240.82 218.46 C 241.52 219.56 241.28 220.73 240.88 221.38 L 235.12 231.72 C 234.73 232.55 233.86 233.26 232.74 233.26 Z" fill="#5184f3" stroke="none" pointer-events="all"/><path d="M 229.65 233.26 L 222.91 226.28 L 221.12 221.54 L 221.01 215.84 L 226.93 213.16 L 233.48 215.38 L 240.33 222.36 L 235.12 231.72 C 234.73 232.55 233.86 233.26 232.74 233.26 Z" fill-opacity="0.07" fill="#000000" stroke="none" pointer-events="all"/><rect x="212.48" y="206.74" width="0" height="0" fill="none" stroke="none" pointer-events="all"/><path d="M 226.95 219.24 C 227.32 219.24 227.85 218.86 227.85 218.27 C 227.85 217.78 227.41 217.35 226.97 217.35 C 226.51 217.35 226.05 217.74 226.05 218.3 C 226.05 218.83 226.58 219.24 226.95 219.24 Z M 227.53 224.87 L 226.38 224.87 L 226.38 224.07 L 225.51 224.07 L 225.51 222.96 L 226.38 222.96 L 226.38 222.57 L 224.81 222.57 L 224.81 221.46 L 226.38 221.46 L 226.38 220.27 C 225.57 220.11 224.91 219.32 224.91 218.34 C 224.91 217.04 225.92 216.23 226.97 216.23 C 227.93 216.23 228.97 217.01 228.97 218.32 C 228.97 219.23 228.44 220.03 227.53 220.24 Z M 226.97 227.51 C 228.69 226.91 230.06 225.77 230.63 224.96 C 231.86 223.31 232.41 221.42 232.41 219.8 L 232.41 216.13 L 226.94 213.63 L 221.48 216.16 L 221.48 219.78 C 221.48 221.71 222.38 224.05 223.64 225.39 C 224.64 226.44 225.59 227.05 226.97 227.51 Z M 226.99 228.71 C 225.18 228.24 223.61 227.32 222.29 225.52 C 221.1 223.92 220.43 222.09 220.43 220.12 L 220.43 215.38 L 226.98 212.33 L 233.48 215.38 L 233.48 220.42 C 233.48 222.45 232.36 224.66 231.26 225.94 C 230.22 227.18 229.02 228.17 226.99 228.71 Z" fill="#ffffff" stroke="none" pointer-events="all"/><rect x="270" y="213.33" width="150" height="13.33" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 148px; height: 1px; padding-top: 220px; margin-left: 271px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">CODA-19 site API key</div></div></div></foreignObject><text x="345" y="224" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">CODA-19 site API key</text></switch></g><rect x="0" y="158" width="150" height="30" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe flex-start; width: 148px; height: 1px; padding-top: 173px; margin-left: 2px;"><div style="box-sizing: border-box; font-size: 0; text-align: left; "><div style="display: inline-block; font-size: 22px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">Green VM</div></div></div></foreignObject><text x="2" y="180" fill="#000000" font-family="Helvetica" font-size="22px">Green VM</text></switch></g><rect x="0" y="325" width="150" height="30" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe flex-start; width: 148px; height: 1px; padding-top: 340px; margin-left: 2px;"><div style="box-sizing: border-box; font-size: 0; text-align: left; "><div style="display: inline-block; font-size: 22px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">Master VM</div></div></div></foreignObject><text x="2" y="347" fill="#000000" font-family="Helvetica" font-size="22px">Master VM</text></switch></g><rect x="0" y="640" width="150" height="30" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe flex-start; width: 148px; height: 1px; padding-top: 655px; margin-left: 2px;"><div style="box-sizing: border-box; font-size: 0; text-align: left; "><div style="display: inline-block; font-size: 22px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">Client app</div></div></div></foreignObject><text x="2" y="662" fill="#000000" font-family="Helvetica" font-size="22px">Client app</text></switch></g><path d="M 0 0 L 1240 0" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 840 430 L 871.76 430" fill="none" stroke="#000000" stroke-width="2" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 877.76 430 L 869.76 434 L 871.76 430 L 869.76 426 Z" fill="#000000" stroke="#000000" stroke-width="2" stroke-miterlimit="10" pointer-events="all"/><rect x="720" y="400" width="120" height="60" fill="#e1d5e7" stroke="#9673a6" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 430px; margin-left: 721px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">CODA-19 hub API</div></div></div></foreignObject><text x="780" y="434" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">CODA-19 hub API</text></switch></g><path d="M 780 260 L 780 391.76" fill="none" stroke="#000000" stroke-width="2" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 780 397.76 L 776 389.76 L 780 391.76 L 784 389.76 Z" fill="#000000" stroke="#000000" stroke-width="2" stroke-miterlimit="10" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 346px; margin-left: 782px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 22px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; background-color: #ffffff; white-space: nowrap; "><font style="font-size: 11px ; line-height: 90%"><br /></font></div></div></div></foreignObject><text x="782" y="352" fill="#000000" font-family="Helvetica" font-size="22px" text-anchor="middle"></text></switch></g><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 341px; margin-left: 780px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 22px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; background-color: #ffffff; white-space: nowrap; "><span style="font-size: 13px">establish secure channel<br /></span></div></div></div></foreignObject><text x="780" y="347" fill="#000000" font-family="Helvetica" font-size="22px" text-anchor="middle">establish secure channel&#xa;</text></switch></g><rect x="720" y="200" width="120" height="60" fill="#d5e8d4" stroke="#82b366" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 230px; margin-left: 721px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">CODA-19 site API</div></div></div></foreignObject><text x="780" y="234" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">CODA-19 site API</text></switch></g><path d="M 940 345 L 940 268.24" fill="none" stroke="#000000" stroke-width="2" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 940 262.24 L 944 270.24 L 940 268.24 L 936 270.24 Z" fill="#000000" stroke="#000000" stroke-width="2" stroke-miterlimit="10" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 301px; margin-left: 941px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 22px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; background-color: #ffffff; white-space: nowrap; "><font style="font-size: 13px">WebSocket <b>send</b><br /></font></div></div></div></foreignObject><text x="941" y="308" fill="#000000" font-family="Helvetica" font-size="22px" text-anchor="middle">WebSocket send&#xa;</text></switch></g><rect x="880" y="400" width="120" height="60" fill="#e1d5e7" stroke="#9673a6" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 430px; margin-left: 881px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">CODA-19 hub API</div></div></div></foreignObject><text x="940" y="434" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">CODA-19 hub API</text></switch></g><path d="M 939.5 118 L 939.5 98 L 940 98 L 940 93.24" fill="none" stroke="#000000" stroke-width="2" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 940 87.24 L 944 95.24 L 940 93.24 L 936 95.24 Z" fill="#000000" stroke="#000000" stroke-width="2" stroke-miterlimit="10" pointer-events="all"/><rect x="722" y="118" width="290" height="40" rx="1" ry="1" fill="#000000" stroke="#000000" transform="translate(2,3)" opacity="0.25"/><rect x="722" y="118" width="290" height="40" rx="1" ry="1" fill="#ffffff" stroke="#dddddd" pointer-events="all"/><path d="M 743.19 151.26 C 742.2 151.26 741.26 150.72 740.77 149.7 L 735 139.3 C 734.48 138.39 734.56 137.33 735 136.58 L 740.82 126.17 C 741.31 125.23 742.2 124.74 743.09 124.74 L 754.78 124.74 C 755.65 124.74 756.51 125.18 757.02 126.07 L 762.82 136.46 C 763.52 137.56 763.28 138.73 762.88 139.38 L 757.12 149.72 C 756.73 150.55 755.86 151.26 754.74 151.26 Z" fill="#5184f3" stroke="none" pointer-events="all"/><path d="M 751.65 151.26 L 744.91 144.28 L 743.12 139.54 L 743.01 133.84 L 748.93 131.16 L 755.48 133.38 L 762.33 140.36 L 757.12 149.72 C 756.73 150.55 755.86 151.26 754.74 151.26 Z" fill-opacity="0.07" fill="#000000" stroke="none" pointer-events="all"/><rect x="734.48" y="124.74" width="0" height="0" fill="none" stroke="none" pointer-events="all"/><path d="M 748.95 137.24 C 749.32 137.24 749.85 136.86 749.85 136.27 C 749.85 135.78 749.41 135.35 748.97 135.35 C 748.51 135.35 748.05 135.74 748.05 136.3 C 748.05 136.83 748.58 137.24 748.95 137.24 Z M 749.53 142.87 L 748.38 142.87 L 748.38 142.07 L 747.51 142.07 L 747.51 140.96 L 748.38 140.96 L 748.38 140.57 L 746.81 140.57 L 746.81 139.46 L 748.38 139.46 L 748.38 138.27 C 747.57 138.11 746.91 137.32 746.91 136.34 C 746.91 135.04 747.92 134.23 748.97 134.23 C 749.93 134.23 750.97 135.01 750.97 136.32 C 750.97 137.23 750.44 138.03 749.53 138.24 Z M 748.97 145.51 C 750.69 144.91 752.06 143.77 752.63 142.96 C 753.86 141.31 754.41 139.42 754.41 137.8 L 754.41 134.13 L 748.94 131.63 L 743.48 134.16 L 743.48 137.78 C 743.48 139.71 744.38 142.05 745.64 143.39 C 746.64 144.44 747.59 145.05 748.97 145.51 Z M 748.99 146.71 C 747.18 146.24 745.61 145.32 744.29 143.52 C 743.1 141.92 742.43 140.09 742.43 138.12 L 742.43 133.38 L 748.98 130.33 L 755.48 133.38 L 755.48 138.42 C 755.48 140.45 754.36 142.66 753.26 143.94 C 752.22 145.18 751.02 146.17 748.99 146.71 Z" fill="#ffffff" stroke="none" pointer-events="all"/><rect x="793" y="131.33" width="180" height="13.33" fill="none" stroke="none" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 178px; height: 1px; padding-top: 138px; margin-left: 794px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">AidBox READ user credentials</div></div></div></foreignObject><text x="883" y="142" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">AidBox READ user credentials</text></switch></g><path d="M 1100 375 L 1100 395 L 1100 380 L 1100 391.76" fill="none" stroke="#000000" stroke-width="2" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 1100 397.76 L 1096 389.76 L 1100 391.76 L 1104 389.76 Z" fill="#000000" stroke="#000000" stroke-width="2" stroke-miterlimit="10" pointer-events="all"/><rect x="1040" y="200" width="120" height="60" fill="#d5e8d4" stroke="#82b366" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 230px; margin-left: 1041px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">CODA-19 site API</div></div></div></foreignObject><text x="1100" y="234" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">CODA-19 site API</text></switch></g><path d="M 1100 460 L 1100 691.76" fill="none" stroke="#000000" stroke-width="2" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 1100 697.76 L 1096 689.76 L 1100 691.76 L 1104 689.76 Z" fill="#000000" stroke="#000000" stroke-width="2" stroke-miterlimit="10" pointer-events="all"/><rect x="1040" y="400" width="120" height="60" fill="#e1d5e7" stroke="#9673a6" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 430px; margin-left: 1041px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">CODA-19 hub API</div></div></div></foreignObject><text x="1100" y="434" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">CODA-19 hub API</text></switch></g><rect x="1040" y="700" width="120" height="60" fill="#f5f5f5" stroke="#666666" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 730px; margin-left: 1041px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #333333; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">Client receives<br />data</div></div></div></foreignObject><text x="1100" y="734" fill="#333333" font-family="Helvetica" font-size="12px" text-anchor="middle">Client receives...</text></switch></g><ellipse cx="940" cy="360" rx="15" ry="15" fill="#fff2cc" stroke="#d6b656" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 28px; height: 1px; padding-top: 360px; margin-left: 926px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 14px; font-family: Courier New; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; "><font style="font-size: 22px"><b>1</b></font></div></div></div></foreignObject><text x="940" y="364" fill="#000000" font-family="Courier New" font-size="14px" text-anchor="middle">1</text></switch></g><path d="M 940 400 L 940 380 L 940 395 L 940 383.24" fill="none" stroke="#000000" stroke-width="2" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 940 377.24 L 944 385.24 L 940 383.24 L 936 385.24 Z" fill="#000000" stroke="#000000" stroke-width="2" stroke-miterlimit="10" pointer-events="all"/><ellipse cx="1100" cy="360" rx="15" ry="15" fill="#fff2cc" stroke="#d6b656" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 28px; height: 1px; padding-top: 360px; margin-left: 1086px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 14px; font-family: Courier New; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; "><font style="font-size: 22px"><b>2</b></font></div></div></div></foreignObject><text x="1100" y="364" fill="#000000" font-family="Courier New" font-size="14px" text-anchor="middle">2</text></switch></g><path d="M 1100 260 L 1100 336.76" fill="none" stroke="#000000" stroke-width="2" stroke-miterlimit="10" pointer-events="stroke"/><path d="M 1100 342.76 L 1096 334.76 L 1100 336.76 L 1104 334.76 Z" fill="#000000" stroke="#000000" stroke-width="2" stroke-miterlimit="10" pointer-events="all"/><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 302px; margin-left: 1101px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 22px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; background-color: #ffffff; white-space: nowrap; "><span style="font-size: 13px">WebSocket <b>receive</b></span></div></div></div></foreignObject><text x="1101" y="308" fill="#000000" font-family="Helvetica" font-size="22px" text-anchor="middle">WebSocket receive</text></switch></g></g><switch><g requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"/><a transform="translate(0,-5)" xlink:href="https://desk.draw.io/support/solutions/articles/16000042487" target="_blank"><text text-anchor="middle" font-size="10px" x="50%" y="100%">Viewer does not support full SVG 1.1</text></a></switch></svg>

## Keycloak

**List of clients**
```
dashboard <VALERIA base url>/dashboard
sites-chum <SITE base IP>/api
sites-chuq <SITE base IP>/api
```

## Auth Flow

**1. Le dashboard user s'authentifie avec Keycloak-JS:**

```js
const keycloak = new Keycloak({
    url: '<VALERIA base url>/dashboard/auth',
    realm: 'coda19',
    scope: 'openid'
    clientId: 'dashboard',
    realmPublicKey: 'MIIBIjANB...'
})

keycloak.init().then(function(authenticated) {
  alert(authenticated ? 'authenticated' : 'not authenticated');
}).catch(function() {
  alert('failed to initialize');
})
```

2. Le client peut faire des requêtes autorisées:

```js
const loadData = function () {

    const url = 'http://localhost:8080/restful-service'

    const req = new XMLHttpRequest()
    req.open('GET', url, true)
    req.setRequestHeader('Accept', 'application/json')
    // Set the JWT as the header
    req.setRequestHeader('Authorization', 'Bearer ' + keycloak.token)

    req.onreadystatechange = function () {
        if (req.readyState == 4) {
            if (req.status == 200) {
                alert('Success')
            } else if (req.status == 403) {
                alert('Forbidden')
            }
        }
    }

    req.send()
}
```

3. Le hub API s'authentifie aux sites avec Keycloak-NodeJS au moment d'établir la connection WebSocket. 

```shell
npm install keycloak-connect --save
npm install express-session --save
```

```js
let kcConfig = {
  clientId: 'sites-chum',
  bearerOnly: true,
  serverUrl: '<CHUM base IP>/api/auth',
  scope: 'openid'
  realm: 'coda19',
  username: 'hub',
  password: 'hub'
}

const session = require('express-session')
const Keycloak = require('keycloak-connect')

let _keycloak

function initKeycloak() {
  if (_keycloak) {
    console.warn("Trying to init Keycloak again!")
    return _keycloak;
  }  else {
    console.log("Initializing Keycloak...")
    let memoryStore = new session.MemoryStore()
    _keycloak = new Keycloak({ store: memoryStore }, kcConfig)
    return _keycloak
  }
}

function getKeycloak() {
  if (!_keycloak){
    console.error('Keycloak has not been initialized. Please called init first.');
  } 
  return _keycloak;
}

module.exports = {
  initKeycloak,
  getKeycloak
}
```

**4. Un utilisateur envoie une demande au hub API via un POST sur le backend du dashboard:** 

```js
// Include JWT token for authentication of user to dashboard client in header (keycloak.token)
Authorization: Bearer xxxxx.yyyyy.zzzzz
{

  "data": {
    "action": "summarize",
    // Represented in GraphQL
    "filter": `{
      subject {
         reference
            resource(type : Patient) { age, sex, deceased }
      }
    }`,
    "options": { "limit": 100, "ops": ["mean", "median", "max"] }
  }

}
```

**5. Le hub forward la demande à tous les sites concernés via un message WebSocket JSON:

```js
{
  
  // Include JWT token for authentication of hub-api to site-api in header (_keycloak.token)
  "type": "message",
  "authorization": "xxxxx.yyyyy.zzzzz",
  "description": "This message gets a summary of patient ages.",
  "destination": {
    "site": "110",
    "service": "stats"
  },

  "data": {
    "action": "summarize",
    // Represented in GraphQL
    "filter": `{
      subject {
         reference
            resource(type : Patient) { age, sex, deceased }
      }
    }`,
    "options": { "limit": 100, "ops": ["mean", "median", "max"] }
  }

}
```

**6. Les sites retournent la réponse via le WebSocket 

```json
{

  "type": "response",
  "description": "This is a response with the patient ages.",
  "destination": {
    "site": "000",
    "service": "stats"
  },

  "data": {
    "num_records": 23,
    "variables": [
      { "name": "age", "mean": 73, "median": 56, "max": 100 }
    ]
}
```
